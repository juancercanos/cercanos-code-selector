<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cercanos | Quality & Risk Code Selector</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #faf8f5 0%, #f5f0eb 100%);
            min-height: 100vh;
            color: #2d1628;
        }
        :root {
            --orange: #de8130;
            --tan: #a47864;
            --deep-purple: #2d1628;
            --blush: #e6d9d3;
            --brown: #5a4b44;
            --olive: #777b41;
            --gold: #f3bf57;
            --navy: #2f6089;
            --purple: #652875;
            --green: #4caf50;
            --red: #e53935;
            --teal: #00897b;
        }

        /* Header */
        .header {
            background: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(45, 22, 40, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-text { font-size: 22px; font-weight: 700; color: var(--olive); }
        .heart-icon { color: var(--orange); font-size: 18px; }
        .tagline { font-size: 11px; color: var(--tan); font-style: italic; }

        /* Quick Links Bar */
        .quick-links {
            background: linear-gradient(135deg, var(--deep-purple) 0%, #4a2d42 100%);
            padding: 8px 24px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .quick-links-label { color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 500; }
        .quick-link {
            color: white;
            text-decoration: none;
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            transition: all 0.2s;
        }
        .quick-link:hover { background: rgba(255,255,255,0.25); }
        .quick-link.active { background: var(--orange); }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 1fr; }
        }

        /* Left Panel */
        .left-panel { display: flex; flex-direction: column; gap: 16px; }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(45, 22, 40, 0.04);
        }
        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--blush);
        }
        .panel-icon {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
        }
        .panel-icon.cardio { background: #fff3e0; }
        .panel-icon.behavioral { background: #e8f5e9; }
        .panel-icon.meds { background: #e3f2fd; }
        .panel-icon.screening { background: #f3e5f5; }
        .panel-title { font-size: 14px; font-weight: 600; color: var(--deep-purple); }

        /* Input Groups */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group { display: flex; flex-direction: column; gap: 3px; }
        .input-group.full-width { grid-column: span 2; }
        .input-label { font-size: 11px; font-weight: 500; color: var(--brown); }
        .input-label .unit { color: var(--tan); }
        .input-field {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
        }
        .input-field:focus { outline: none; border-color: var(--olive); }
        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235a4b44' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        /* Medication Accordion */
        .med-category {
            margin-bottom: 8px;
            border: 1px solid var(--blush);
            border-radius: 8px;
            overflow: hidden;
        }
        .med-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--deep-purple);
            transition: background 0.2s;
        }
        .med-category-header:hover { background: var(--blush); }
        .med-category-header .count {
            background: var(--olive);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        .med-category-header .arrow {
            transition: transform 0.2s;
        }
        .med-category.expanded .med-category-header .arrow {
            transform: rotate(180deg);
        }
        .med-category-content {
            display: none;
            padding: 8px;
            background: white;
        }
        .med-category.expanded .med-category-content {
            display: block;
        }
        .med-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .med-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: #faf8f5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        .med-item:hover { background: var(--blush); }
        .med-item.selected { background: linear-gradient(135deg, rgba(222,129,48,0.15) 0%, rgba(243,191,87,0.15) 100%); border: 1px solid var(--orange); }
        .med-item input { cursor: pointer; }
        .med-name { flex: 1; color: var(--deep-purple); }
        .med-class { font-size: 9px; color: var(--tan); }

        /* Screening Items */
        .screening-grid {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
        }
        .screening-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #faf8f5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        .screening-item:hover { background: var(--blush); }
        .screening-item.selected { background: linear-gradient(135deg, rgba(101,40,117,0.1) 0%, rgba(199,106,30,0.1) 100%); border: 1px solid var(--purple); }
        .screening-item.inactive {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f0f0f0;
        }
        .screening-item input { cursor: pointer; }
        .screening-item input:disabled { cursor: not-allowed; }
        .screening-name { flex: 1; color: var(--deep-purple); font-weight: 500; }
        .screening-age { font-size: 9px; color: var(--tan); white-space: nowrap; }
        .screening-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
        }
        .screening-badge.active { background: #e8f5e9; color: #2e7d32; }
        .screening-badge.inactive { background: #ffebee; color: #c62828; }

        /* Right Panel */
        .right-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(45, 22, 40, 0.04);
        }
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blush);
        }
        .output-title { font-size: 16px; font-weight: 600; color: var(--deep-purple); }
        .clear-btn {
            padding: 6px 14px;
            background: var(--blush);
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            color: var(--brown);
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--blush);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 14px;
            border: none;
            background: transparent;
            font-size: 12px;
            font-weight: 500;
            color: var(--tan);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .tab:hover { background: var(--blush); color: var(--brown); }
        .tab.active { background: var(--orange); color: white; }
        .tab.suspect { background: var(--purple); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Section Controls */
        .section-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
        }
        .section-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .section-badge.quality { background: #e3f2fd; color: #1565c0; }
        .section-badge.icd { background: #f3e5f5; color: var(--purple); }
        .section-badge.hcc { background: #fff3e0; color: #e65100; }
        .section-badge.suspect { background: #fce4ec; color: #c2185b; }
        .section-title { font-size: 12px; font-weight: 600; color: var(--deep-purple); }
        .section-buttons {
            display: flex;
            gap: 8px;
        }
        .section-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .section-btn.accept-all { background: var(--green); color: white; }
        .section-btn.accept-all:hover { background: #388e3c; }
        .section-btn.reject-all { background: var(--red); color: white; }
        .section-btn.reject-all:hover { background: #c62828; }

        /* Code Cards */
        .code-section { margin-bottom: 20px; }
        .code-list { display: flex; flex-direction: column; gap: 6px; }
        .code-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #faf8f5;
            border-radius: 6px;
            border-left: 3px solid #cbd5e0;
            transition: all 0.2s;
        }
        .code-card:hover { background: var(--blush); }
        .code-card.accepted { background: #e8f5e9; border-left-color: var(--green); }
        .code-card.rejected { background: #ffebee; border-left-color: var(--red); opacity: 0.6; }
        .code-card.has-hcc {
            border-left-color: var(--orange);
            background: linear-gradient(90deg, rgba(222,129,48,0.08) 0%, #faf8f5 100%);
        }
        .code-card.has-hcc.accepted {
            background: linear-gradient(90deg, rgba(222,129,48,0.15) 0%, #e8f5e9 100%);
            border-left-color: var(--green);
        }
        .code-card.suspect-code {
            border-left-color: var(--purple);
            background: linear-gradient(90deg, rgba(101,40,117,0.08) 0%, #faf8f5 100%);
        }

        .code-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            font-weight: 700;
            color: var(--purple);
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            min-width: 65px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .code-info { flex: 1; }
        .code-desc { font-size: 12px; color: var(--deep-purple); margin-bottom: 3px; }
        .code-meta { display: flex; gap: 6px; flex-wrap: wrap; }
        .hcc-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--orange) 0%, #c76a1e 100%);
            color: white;
        }
        .hcc-badge .raf { background: rgba(255,255,255,0.3); padding: 1px 3px; border-radius: 3px; }
        .payer-badge {
            padding: 1px 5px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 600;
        }
        .payer-badge.ma { background: #fff3e0; color: #e65100; }
        .payer-badge.comm { background: #e3f2fd; color: #1565c0; }

        /* Accept/Reject Buttons */
        .action-btns {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        .accept-btn, .reject-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .accept-btn { background: #c8e6c9; color: #2e7d32; }
        .accept-btn:hover { background: var(--green); color: white; }
        .accept-btn.active { background: var(--green); color: white; }
        .reject-btn { background: #ffcdd2; color: #c62828; }
        .reject-btn:hover { background: var(--red); color: white; }
        .reject-btn.active { background: var(--red); color: white; }

        /* Documentation Cards */
        .doc-card {
            background: #f8fdf8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .doc-card.selected { border-color: var(--olive); border-width: 2px; }
        .doc-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .doc-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .doc-card-title { font-size: 12px; font-weight: 600; color: var(--olive); flex: 1; }
        .doc-text {
            font-size: 12px;
            color: var(--deep-purple);
            line-height: 1.5;
            font-family: Georgia, serif;
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e8f5e9;
            width: 100%;
            min-height: 60px;
            resize: vertical;
        }

        /* Suspect Codes */
        .suspect-alert {
            background: linear-gradient(135deg, rgba(101,40,117,0.1) 0%, rgba(199,106,30,0.1) 100%);
            border: 2px solid var(--purple);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .suspect-alert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .suspect-alert-title { font-size: 13px; font-weight: 600; color: var(--purple); }
        .suspect-alert-text { font-size: 12px; color: var(--deep-purple); }

        /* RAF Summary */
        .raf-summary {
            background: linear-gradient(135deg, rgba(222,129,48,0.1) 0%, rgba(243,191,87,0.1) 100%);
            border: 2px solid var(--orange);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .raf-summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .raf-summary-title { font-size: 13px; font-weight: 600; color: var(--orange); }
        .raf-values { display: flex; gap: 24px; }
        .raf-item { }
        .raf-label { font-size: 11px; color: var(--brown); }
        .raf-value { font-size: 22px; font-weight: 700; color: var(--orange); }

        /* Selection Counter */
        .selection-counter {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 8px 12px;
            background: var(--blush);
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .counter-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--brown);
        }
        .counter-value {
            font-weight: 700;
            color: var(--olive);
            background: white;
            padding: 1px 6px;
            border-radius: 10px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--blush);
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .action-btn.primary { background: linear-gradient(135deg, var(--olive) 0%, #5a5d32 100%); color: white; }
        .action-btn.secondary { background: linear-gradient(135deg, var(--orange) 0%, #c76a1e 100%); color: white; }
        .action-btn.athena { background: linear-gradient(135deg, var(--navy) 0%, #1e4d6b 100%); color: white; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--tan);
        }
        .empty-state-icon { font-size: 40px; margin-bottom: 10px; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--tan);
            font-size: 12px;
        }

        /* Summary Note */
        .summary-note {
            background: white;
            border: 2px solid var(--olive);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .summary-section { margin-bottom: 12px; }
        .summary-section-title { font-weight: bold; color: var(--olive); margin-bottom: 4px; }

        /* Diagnosis Dropdown Section */
        .dx-dropdown-container {
            margin-bottom: 10px;
        }
        .dx-selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .dx-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: linear-gradient(135deg, rgba(222,129,48,0.15) 0%, rgba(243,191,87,0.15) 100%);
            border: 1px solid var(--orange);
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            color: var(--deep-purple);
        }
        .dx-tag .remove-dx {
            cursor: pointer;
            color: var(--red);
            font-weight: bold;
            margin-left: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <span class="heart-icon">‚ù§Ô∏è</span>
            <span class="logo-text">Cercanos</span>
            <span class="tagline">connecting care & community</span>
        </div>
        <div style="font-size: 12px; color: var(--tan);">Quality & Risk Code Selector</div>
    </div>

    <div class="quick-links">
        <span class="quick-links-label">Quick Access:</span>
        <a href="#" class="quick-link active">üìã Code Selector</a>
        <a href="https://juancercanos.github.io/cercanos-caremanagement/#metrics" class="quick-link">üìä Metrics Dashboard</a>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <!-- Patient Demographics -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon" style="background: #e8f5e9;">üë§</div>
                    <div class="panel-title">Patient Demographics</div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">Age <span class="unit">(years)</span></label>
                        <input type="number" class="input-field" id="patientAge" placeholder="65" min="0" max="120" onchange="updateScreeningEligibility()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Sex</label>
                        <select class="input-field" id="patientSex" onchange="updateScreeningEligibility()">
                            <option value="">Select...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                </div>
                <div class="dx-dropdown-container">
                    <label class="input-label">Add Cardiometabolic Diagnosis</label>
                    <select class="input-field" id="dxDropdown" onchange="addDiagnosis()">
                        <option value="">Select diagnosis to add...</option>
                        <option value="E11.9">E11.9 - Type 2 Diabetes Mellitus</option>
                        <option value="I10">I10 - Essential Hypertension</option>
                        <option value="E78.5">E78.5 - Hyperlipidemia</option>
                        <option value="E66.9">E66.9 - Obesity, unspecified</option>
                        <option value="I50.9">I50.9 - Heart Failure</option>
                        <option value="I25.10">I25.10 - Coronary Artery Disease</option>
                        <option value="N18.3">N18.3 - Chronic Kidney Disease Stage 3</option>
                        <option value="I48.91">I48.91 - Atrial Fibrillation</option>
                        <option value="I73.9">I73.9 - Peripheral Vascular Disease</option>
                        <option value="E03.9">E03.9 - Hypothyroidism</option>
                    </select>
                    <div class="dx-selected-list" id="selectedDxList"></div>
                </div>
            </div>

            <!-- Clinical Values -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon cardio">ü©∫</div>
                    <div class="panel-title">Clinical Values</div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">Systolic BP <span class="unit">(mmHg)</span></label>
                        <input type="number" class="input-field" id="sbp" placeholder="120">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Diastolic BP <span class="unit">(mmHg)</span></label>
                        <input type="number" class="input-field" id="dbp" placeholder="80">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">A1C <span class="unit">(%)</span></label>
                        <input type="number" step="0.1" class="input-field" id="a1c" placeholder="6.5">
                    </div>
                    <div class="input-group">
                        <label class="input-label">LDL <span class="unit">(mg/dL)</span></label>
                        <input type="number" class="input-field" id="ldl" placeholder="100">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">BMI <span class="unit">(kg/m¬≤)</span></label>
                        <input type="number" step="0.1" class="input-field" id="bmi" placeholder="25.0">
                    </div>
                    <div class="input-group">
                        <label class="input-label">eGFR <span class="unit">(mL/min)</span></label>
                        <input type="number" class="input-field" id="egfr" placeholder="90">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">PHQ-9 Score</label>
                        <select class="input-field" id="phq9">
                            <option value="">Select score...</option>
                            <option value="0">0-4 (Minimal)</option>
                            <option value="5">5-9 (Mild)</option>
                            <option value="10">10-14 (Moderate)</option>
                            <option value="15">15-19 (Mod-Severe)</option>
                            <option value="20">20-27 (Severe)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">GAD-7 Score</label>
                        <select class="input-field" id="gad7">
                            <option value="">Select score...</option>
                            <option value="0">0-4 (Minimal)</option>
                            <option value="5">5-9 (Mild)</option>
                            <option value="10">10-14 (Moderate)</option>
                            <option value="15">15-21 (Severe)</option>
                        </select>
                    </div>
                </div>
                <button class="action-btn primary" style="width:100%; margin-top: 10px;" onclick="generateCodes()">
                    üîç Generate Code Recommendations
                </button>
            </div>

            <!-- USPSTF Screening -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon screening">üî¨</div>
                    <div class="panel-title">USPSTF Screening Measures</div>
                </div>
                <p style="font-size: 10px; color: var(--tan); margin-bottom: 10px;">Select screenings performed. Eligibility based on patient age/sex.</p>
                <div class="screening-grid" id="screeningGrid"></div>
            </div>

            <!-- Medications -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon meds">üíä</div>
                    <div class="panel-title">Current Medications</div>
                </div>
                <div id="medAccordion"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="output-header">
                <div class="output-title">Recommended Codes</div>
                <button class="clear-btn" onclick="clearAll()">Clear All</button>
            </div>

            <div class="selection-counter" id="selectionCounter">
                <div class="counter-item">Quality: <span class="counter-value" id="qualityCount">0</span></div>
                <div class="counter-item">ICD-10: <span class="counter-value" id="icdCount">0</span></div>
                <div class="counter-item">Suspect: <span class="counter-value" id="suspectCount">0</span></div>
                <div class="counter-item">Docs: <span class="counter-value" id="docCount">0</span></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('quality')">Quality Codes</button>
                <button class="tab" onclick="showTab('icd')">ICD-10 + HCC</button>
                <button class="tab" onclick="showTab('suspect')">Suspect Diagnoses</button>
                <button class="tab" onclick="showTab('documentation')">Documentation</button>
                <button class="tab" onclick="showTab('summary')">Summary Note</button>
            </div>

            <!-- Quality Codes Tab -->
            <div id="quality-tab" class="tab-content active">
                <div id="cptii-section" class="code-section"></div>
                <div id="gcode-section" class="code-section"></div>
                <div id="mips-section" class="code-section"></div>
            </div>

            <!-- ICD-10 Tab -->
            <div id="icd-tab" class="tab-content">
                <div class="raf-summary">
                    <div class="raf-summary-header">
                        <span>üìà</span>
                        <span class="raf-summary-title">RAF Impact (Accepted Codes)</span>
                    </div>
                    <div class="raf-values">
                        <div class="raf-item">
                            <div class="raf-label">Medicare Advantage</div>
                            <div class="raf-value" id="rafMa">0.000</div>
                        </div>
                        <div class="raf-item">
                            <div class="raf-label">Commercial (ACA)</div>
                            <div class="raf-value" id="rafComm">0.000</div>
                        </div>
                    </div>
                </div>
                <div id="icd-section" class="code-section"></div>
            </div>

            <!-- Suspect Diagnoses Tab -->
            <div id="suspect-tab" class="tab-content">
                <div class="suspect-alert">
                    <div class="suspect-alert-header">
                        <span>üîç</span>
                        <span class="suspect-alert-title">Medication-Based Suspect Diagnoses</span>
                    </div>
                    <div class="suspect-alert-text">Based on selected medications, these diagnoses should be evaluated and documented if clinically appropriate.</div>
                </div>
                <div id="suspect-section" class="code-section"></div>
            </div>

            <!-- Documentation Tab -->
            <div id="documentation-tab" class="tab-content">
                <p style="font-size: 12px; color: var(--tan); margin-bottom: 16px;">
                    Documentation snippets for <strong>accepted diagnoses only</strong>. Edit as needed and check to include in summary.
                </p>
                <div id="doc-section"></div>
            </div>

            <!-- Summary Tab -->
            <div id="summary-tab" class="tab-content">
                <button class="action-btn secondary" style="margin-bottom: 16px;" onclick="copySummary()">
                    üìã Copy to Clipboard
                </button>
                <div class="summary-note" id="summaryNote">
                    Enter clinical values and accept codes to generate summary...
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn primary" onclick="generateSummary()">üìù Generate Summary</button>
                <button class="action-btn athena" onclick="copyToAthena()">üè• Copy to Athena</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>‚ù§Ô∏è Cercanos Care | Quality & Risk Adjustment Tool</p>
        <p style="margin-top: 4px;">¬© 2025 Cercanos Care. All rights reserved.</p>
    </div>

    <script>
        // ============ MEDICATIONS DATABASE (Grouped by Condition) ============
        const medicationsByCondition = {
            'Diabetes': [
                { name: 'Metformin', class: 'Biguanide', suspects: ['E11.9', 'E11.65'] },
                { name: 'Glipizide', class: 'Sulfonylurea', suspects: ['E11.9', 'E11.65'] },
                { name: 'Glimepiride', class: 'Sulfonylurea', suspects: ['E11.9', 'E11.65'] },
                { name: 'Ozempic (Semaglutide)', class: 'GLP-1', suspects: ['E11.9', 'E66.01'] },
                { name: 'Trulicity (Dulaglutide)', class: 'GLP-1', suspects: ['E11.9', 'E66.01'] },
                { name: 'Mounjaro (Tirzepatide)', class: 'GIP/GLP-1', suspects: ['E11.9', 'E66.01'] },
                { name: 'Jardiance (Empagliflozin)', class: 'SGLT2i', suspects: ['E11.9', 'I50.9'] },
                { name: 'Farxiga (Dapagliflozin)', class: 'SGLT2i', suspects: ['E11.9', 'I50.9', 'N18.3'] },
                { name: 'Insulin Glargine', class: 'Insulin', suspects: ['E11.9', 'E11.65'] },
                { name: 'Insulin Lispro', class: 'Insulin', suspects: ['E11.9', 'E11.65'] },
            ],
            'Hypertension': [
                { name: 'Lisinopril', class: 'ACEi', suspects: ['I10', 'I50.9', 'N18.3'] },
                { name: 'Enalapril', class: 'ACEi', suspects: ['I10', 'I50.9'] },
                { name: 'Losartan', class: 'ARB', suspects: ['I10', 'I50.9', 'N18.3'] },
                { name: 'Valsartan', class: 'ARB', suspects: ['I10', 'I50.9'] },
                { name: 'Amlodipine', class: 'CCB', suspects: ['I10'] },
                { name: 'Nifedipine', class: 'CCB', suspects: ['I10'] },
                { name: 'Metoprolol', class: 'Beta-blocker', suspects: ['I10', 'I50.9', 'I25.10'] },
                { name: 'Carvedilol', class: 'Beta-blocker', suspects: ['I50.9', 'I10'] },
                { name: 'HCTZ', class: 'Thiazide', suspects: ['I10'] },
                { name: 'Chlorthalidone', class: 'Thiazide', suspects: ['I10'] },
            ],
            'Heart Failure': [
                { name: 'Furosemide', class: 'Loop Diuretic', suspects: ['I50.9', 'N18.4'] },
                { name: 'Bumetanide', class: 'Loop Diuretic', suspects: ['I50.9'] },
                { name: 'Spironolactone', class: 'MRA', suspects: ['I50.9', 'I10'] },
                { name: 'Eplerenone', class: 'MRA', suspects: ['I50.9'] },
                { name: 'Sacubitril/Valsartan', class: 'ARNI', suspects: ['I50.9'] },
                { name: 'Ivabradine', class: 'HCN Blocker', suspects: ['I50.9'] },
                { name: 'Digoxin', class: 'Cardiac Glycoside', suspects: ['I50.9', 'I48.91'] },
                { name: 'Hydralazine', class: 'Vasodilator', suspects: ['I50.9', 'I10'] },
                { name: 'Isosorbide Dinitrate', class: 'Nitrate', suspects: ['I50.9', 'I25.10'] },
                { name: 'Torsemide', class: 'Loop Diuretic', suspects: ['I50.9'] },
            ],
            'Hyperlipidemia': [
                { name: 'Atorvastatin', class: 'Statin', suspects: ['E78.5', 'I25.10'] },
                { name: 'Rosuvastatin', class: 'Statin', suspects: ['E78.5', 'I25.10'] },
                { name: 'Simvastatin', class: 'Statin', suspects: ['E78.5'] },
                { name: 'Pravastatin', class: 'Statin', suspects: ['E78.5'] },
                { name: 'Ezetimibe', class: 'Cholesterol Abs Inh', suspects: ['E78.5'] },
                { name: 'Fenofibrate', class: 'Fibrate', suspects: ['E78.5'] },
                { name: 'Icosapent Ethyl', class: 'Omega-3', suspects: ['E78.5', 'I25.10'] },
                { name: 'Evolocumab', class: 'PCSK9i', suspects: ['E78.5', 'I25.10'] },
                { name: 'Alirocumab', class: 'PCSK9i', suspects: ['E78.5', 'I25.10'] },
                { name: 'Bempedoic Acid', class: 'ACL Inhibitor', suspects: ['E78.5'] },
            ],
            'Mental Health': [
                { name: 'Sertraline', class: 'SSRI', suspects: ['F32.1', 'F41.1'] },
                { name: 'Escitalopram', class: 'SSRI', suspects: ['F32.1', 'F41.1'] },
                { name: 'Fluoxetine', class: 'SSRI', suspects: ['F32.1', 'F41.1'] },
                { name: 'Paroxetine', class: 'SSRI', suspects: ['F32.1', 'F41.1'] },
                { name: 'Bupropion', class: 'NDRI', suspects: ['F32.1', 'F17.210'] },
                { name: 'Venlafaxine', class: 'SNRI', suspects: ['F32.1', 'F41.1'] },
                { name: 'Duloxetine', class: 'SNRI', suspects: ['F32.1', 'F41.1', 'G89.4'] },
                { name: 'Buspirone', class: 'Anxiolytic', suspects: ['F41.1'] },
                { name: 'Mirtazapine', class: 'Tetracyclic', suspects: ['F32.1'] },
                { name: 'Trazodone', class: 'SARI', suspects: ['F32.1', 'G47.00'] },
            ],
            'Anticoagulation': [
                { name: 'Warfarin', class: 'VKA', suspects: ['I48.91', 'I26.99'] },
                { name: 'Apixaban', class: 'DOAC', suspects: ['I48.91', 'I26.99'] },
                { name: 'Rivaroxaban', class: 'DOAC', suspects: ['I48.91', 'I26.99'] },
                { name: 'Dabigatran', class: 'DOAC', suspects: ['I48.91'] },
                { name: 'Edoxaban', class: 'DOAC', suspects: ['I48.91'] },
                { name: 'Aspirin 81mg', class: 'Antiplatelet', suspects: ['I25.10', 'I73.9'] },
                { name: 'Clopidogrel', class: 'Antiplatelet', suspects: ['I25.10', 'I73.9'] },
                { name: 'Ticagrelor', class: 'Antiplatelet', suspects: ['I25.10'] },
                { name: 'Prasugrel', class: 'Antiplatelet', suspects: ['I25.10'] },
                { name: 'Enoxaparin', class: 'LMWH', suspects: ['I26.99'] },
            ],
        };

        // ============ USPSTF SCREENING MEASURES ============
        const screeningMeasures = [
            { id: 'dm-screen', name: 'Diabetes Screening', ages: [35, 70], code: 'G0108', docText: 'Diabetes screening performed per USPSTF guidelines. Fasting glucose/A1C obtained.' },
            { id: 'lipid-screen', name: 'Lipid Screening', ages: [40, 75], code: '82465', docText: 'Lipid panel screening performed per USPSTF guidelines.' },
            { id: 'crc-screen', name: 'Colorectal Cancer Screening', ages: [45, 75], code: 'G0121', docText: 'Colorectal cancer screening discussed/ordered per USPSTF. Options include colonoscopy, FIT, or Cologuard.' },
            { id: 'mammo', name: 'Mammography', ages: [50, 74], sex: 'female', code: '77067', docText: 'Mammography screening discussed/ordered per USPSTF guidelines.' },
            { id: 'ldct', name: 'Lung Cancer Screening (LDCT)', ages: [50, 80], code: 'G0296', docText: 'Low-dose CT lung cancer screening discussed. Patient counseled on eligibility criteria (20+ pack-year history).' },
            { id: 'aaa', name: 'AAA Ultrasound Screening', ages: [65, 75], sex: 'male', code: '76706', docText: 'One-time AAA ultrasound screening discussed/ordered for male patient with smoking history.' },
            { id: 'dexa', name: 'Osteoporosis Screening (DEXA)', ages: [65, 999], sex: 'female', code: '77080', docText: 'DEXA scan for osteoporosis screening discussed/ordered per USPSTF guidelines.' },
            { id: 'hep-c', name: 'Hepatitis C Screening', ages: [18, 79], code: 'G0472', docText: 'One-time Hepatitis C screening performed per USPSTF guidelines.' },
            { id: 'hiv', name: 'HIV Screening', ages: [15, 65], code: 'G0475', docText: 'HIV screening performed per USPSTF guidelines.' },
            { id: 'depression', name: 'Depression Screening', ages: [12, 999], code: 'G0444', docText: 'Annual depression screening performed using PHQ-9. Results documented.' },
            { id: 'anxiety', name: 'Anxiety Screening', ages: [8, 64], code: '96127', docText: 'Anxiety screening performed using GAD-7. Results documented.' },
            { id: 'bp-screen', name: 'Blood Pressure Screening', ages: [18, 999], code: '99473', docText: 'Blood pressure screening performed. Patient counseled on lifestyle modifications if elevated.' },
            { id: 'obesity', name: 'Obesity Screening/Counseling', ages: [6, 999], code: 'G0447', docText: 'BMI calculated and documented. Behavioral weight loss counseling provided.' },
            { id: 'alcohol', name: 'Alcohol Misuse Screening', ages: [18, 999], code: 'G0442', docText: 'Alcohol misuse screening performed using AUDIT-C. Brief counseling provided if indicated.' },
            { id: 'tobacco', name: 'Tobacco Cessation Counseling', ages: [18, 999], code: '99406', docText: 'Tobacco use assessed. Cessation counseling provided. Pharmacotherapy options discussed.' },
            { id: 'statin-prev', name: 'Statin for CVD Prevention', ages: [40, 75], code: '4013F', docText: 'Statin therapy discussed for primary CVD prevention in patient with cardiovascular risk factors.' },
        ];

        // ============ ICD-10 DATABASE ============
        const icdDatabase = {
            'I10': { desc: 'Essential hypertension', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'I11.0': { desc: 'HTN heart disease with HF', hcc_ma: 'HCC 226', raf_ma: 0.368, hcc_comm: 'HCC 160', raf_comm: 0.155 },
            'I12.9': { desc: 'Hypertensive CKD Stage 1-4', hcc_ma: null, raf_ma: 0, hcc_comm: 'HCC 184', raf_comm: 0.174 },
            'I13.0': { desc: 'HTN heart + CKD w/ HF', hcc_ma: 'HCC 226', raf_ma: 0.368, hcc_comm: 'HCC 160', raf_comm: 0.155 },
            'I25.10': { desc: 'CAD without angina', hcc_ma: 'HCC 226', raf_ma: 0.368, hcc_comm: null, raf_comm: 0 },
            'I48.91': { desc: 'Atrial fibrillation, unspecified', hcc_ma: 'HCC 223', raf_ma: 0.271, hcc_comm: null, raf_comm: 0 },
            'I50.9': { desc: 'Heart failure, unspecified', hcc_ma: 'HCC 226', raf_ma: 0.368, hcc_comm: 'HCC 160', raf_comm: 0.155 },
            'I73.9': { desc: 'Peripheral vascular disease', hcc_ma: 'HCC 238', raf_ma: 0.288, hcc_comm: null, raf_comm: 0 },
            'I26.99': { desc: 'Pulmonary embolism', hcc_ma: 'HCC 237', raf_ma: 0.350, hcc_comm: null, raf_comm: 0 },
            'E11.9': { desc: 'Type 2 DM without complications', hcc_ma: 'HCC 37', raf_ma: 0.105, hcc_comm: 'HCC 19', raf_comm: 0.146 },
            'E11.22': { desc: 'Type 2 DM with diabetic CKD', hcc_ma: 'HCC 37', raf_ma: 0.105, hcc_comm: 'HCC 18', raf_comm: 0.302 },
            'E11.65': { desc: 'Type 2 DM with hyperglycemia', hcc_ma: 'HCC 37', raf_ma: 0.105, hcc_comm: 'HCC 19', raf_comm: 0.146 },
            'E66.01': { desc: 'Morbid obesity, BMI >=40', hcc_ma: 'HCC 48', raf_ma: 0.406, hcc_comm: 'HCC 25', raf_comm: 0.383 },
            'E66.3': { desc: 'Overweight', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E66.9': { desc: 'Obesity, unspecified', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E66.811': { desc: 'Obesity class 1 (BMI 30-34.9)', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E66.812': { desc: 'Obesity class 2 (BMI 35-39.9)', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E66.813': { desc: 'Obesity class 3 (BMI >=40)', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E78.5': { desc: 'Hyperlipidemia', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'E03.9': { desc: 'Hypothyroidism, unspecified', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'N18.1': { desc: 'CKD Stage 1', hcc_ma: null, raf_ma: 0, hcc_comm: 'HCC 184', raf_comm: 0.174 },
            'N18.2': { desc: 'CKD Stage 2', hcc_ma: null, raf_ma: 0, hcc_comm: 'HCC 184', raf_comm: 0.174 },
            'N18.3': { desc: 'CKD Stage 3', hcc_ma: null, raf_ma: 0, hcc_comm: 'HCC 184', raf_comm: 0.174 },
            'N18.4': { desc: 'CKD Stage 4', hcc_ma: 'HCC 329', raf_ma: 0.289, hcc_comm: 'HCC 183', raf_comm: 0.335 },
            'N18.5': { desc: 'CKD Stage 5', hcc_ma: 'HCC 326', raf_ma: 0.289, hcc_comm: 'HCC 183', raf_comm: 0.335 },
            'F32.0': { desc: 'Major depression, single, mild', hcc_ma: 'HCC 155', raf_ma: 0.309, hcc_comm: 'HCC 132', raf_comm: 0.309 },
            'F32.1': { desc: 'Major depression, single, moderate', hcc_ma: 'HCC 155', raf_ma: 0.309, hcc_comm: 'HCC 132', raf_comm: 0.309 },
            'F32.2': { desc: 'Major depression, single, severe', hcc_ma: 'HCC 155', raf_ma: 0.309, hcc_comm: 'HCC 132', raf_comm: 0.309 },
            'F33.1': { desc: 'Major depression, recurrent, moderate', hcc_ma: 'HCC 155', raf_ma: 0.309, hcc_comm: 'HCC 132', raf_comm: 0.309 },
            'F41.1': { desc: 'Generalized anxiety disorder', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'F17.210': { desc: 'Nicotine dependence, cigarettes', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'G89.4': { desc: 'Chronic pain syndrome', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
            'G47.00': { desc: 'Insomnia, unspecified', hcc_ma: null, raf_ma: 0, hcc_comm: null, raf_comm: 0 },
        };

        // ============ STATE ============
        let selectedMeds = new Set();
        let expandedCategories = new Set(['Diabetes']); // Default expanded
        let acceptedQuality = new Set();
        let acceptedIcd = new Set();
        let acceptedSuspect = new Set();
        let selectedDocs = new Set();
        let selectedScreenings = new Set();
        let selectedDiagnoses = new Set();
        let docTexts = {};
        let currentCodes = { cptii: [], gcode: [], mips: [], icd: [], suspect: [] };

        // ============ INITIALIZE ============
        function init() {
            renderMedications();
            renderScreenings();
        }

        // ============ DIAGNOSIS DROPDOWN ============
        function addDiagnosis() {
            const dropdown = document.getElementById('dxDropdown');
            const value = dropdown.value;
            if (value && !selectedDiagnoses.has(value)) {
                selectedDiagnoses.add(value);
                renderSelectedDiagnoses();
            }
            dropdown.value = '';
        }

        function removeDiagnosis(code) {
            selectedDiagnoses.delete(code);
            renderSelectedDiagnoses();
        }

        function renderSelectedDiagnoses() {
            const container = document.getElementById('selectedDxList');
            const dxDescriptions = {
                'E11.9': 'Type 2 DM',
                'I10': 'HTN',
                'E78.5': 'Hyperlipidemia',
                'E66.9': 'Obesity',
                'I50.9': 'Heart Failure',
                'I25.10': 'CAD',
                'N18.3': 'CKD Stage 3',
                'I48.91': 'Afib',
                'I73.9': 'PVD',
                'E03.9': 'Hypothyroidism'
            };
            container.innerHTML = Array.from(selectedDiagnoses).map(code => `
                <span class="dx-tag">
                    ${code} - ${dxDescriptions[code] || 'Unknown'}
                    <span class="remove-dx" onclick="removeDiagnosis('${code}')">x</span>
                </span>
            `).join('');
        }

        // ============ SCREENING MEASURES ============
        function updateScreeningEligibility() {
            renderScreenings();
        }

        function renderScreenings() {
            const age = parseInt(document.getElementById('patientAge').value) || 0;
            const sex = document.getElementById('patientSex').value;
            const container = document.getElementById('screeningGrid');

            container.innerHTML = screeningMeasures.map(screen => {
                const ageEligible = age >= screen.ages[0] && age <= screen.ages[1];
                const sexEligible = !screen.sex || screen.sex === sex;
                const isEligible = ageEligible && sexEligible && age > 0;
                const isSelected = selectedScreenings.has(screen.id);

                return `
                    <div class="screening-item ${isSelected ? 'selected' : ''} ${!isEligible ? 'inactive' : ''}"
                         onclick="${isEligible ? `toggleScreening('${screen.id}')` : ''}">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} ${!isEligible ? 'disabled' : ''}>
                        <span class="screening-name">${screen.name}</span>
                        <span class="screening-age">${screen.ages[0]}-${screen.ages[1] === 999 ? 'Inf' : screen.ages[1]}${screen.sex ? ` (${screen.sex})` : ''}</span>
                        <span class="screening-badge ${isEligible ? 'active' : 'inactive'}">${isEligible ? 'Eligible' : 'N/A'}</span>
                    </div>
                `;
            }).join('');
        }

        function toggleScreening(id) {
            if (selectedScreenings.has(id)) {
                selectedScreenings.delete(id);
            } else {
                selectedScreenings.add(id);
            }
            renderScreenings();
            updateDocumentation();
        }

        // ============ MEDICATIONS ============
        function renderMedications() {
            const container = document.getElementById('medAccordion');
            container.innerHTML = Object.entries(medicationsByCondition).map(([category, meds]) => {
                const isExpanded = expandedCategories.has(category);
                const selectedCount = meds.filter((_, i) => selectedMeds.has(`${category}-${i}`)).length;

                return `
                    <div class="med-category ${isExpanded ? 'expanded' : ''}">
                        <div class="med-category-header" onclick="toggleCategory('${category}')">
                            <span>${category}</span>
                            <span class="count">${selectedCount}/${meds.length}</span>
                            <span class="arrow">v</span>
                        </div>
                        <div class="med-category-content">
                            <div class="med-grid">
                                ${meds.map((med, i) => {
                                    const medId = `${category}-${i}`;
                                    const isSelected = selectedMeds.has(medId);
                                    return `
                                        <div class="med-item ${isSelected ? 'selected' : ''}" onclick="toggleMed('${medId}', '${category}', ${i})">
                                            <input type="checkbox" ${isSelected ? 'checked' : ''}>
                                            <span class="med-name">${med.name}</span>
                                            <span class="med-class">${med.class}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCategory(category) {
            if (expandedCategories.has(category)) {
                expandedCategories.delete(category);
            } else {
                expandedCategories.add(category);
            }
            renderMedications();
        }

        function toggleMed(medId, category, index) {
            if (selectedMeds.has(medId)) {
                selectedMeds.delete(medId);
            } else {
                selectedMeds.add(medId);
            }
            renderMedications();
            updateSuspectCodes();
        }

        function getSelectedMedications() {
            const meds = [];
            selectedMeds.forEach(medId => {
                const lastDash = medId.lastIndexOf('-');
                const cat = medId.substring(0, lastDash);
                const idx = parseInt(medId.substring(lastDash + 1));
                if (medicationsByCondition[cat] && medicationsByCondition[cat][idx]) {
                    meds.push(medicationsByCondition[cat][idx]);
                }
            });
            return meds;
        }

        function isOnStatin() {
            return getSelectedMedications().some(med => med.class === 'Statin');
        }

        // ============ CODE GENERATION ============
        function generateCodes() {
            const sbp = parseInt(document.getElementById('sbp').value) || 0;
            const dbp = parseInt(document.getElementById('dbp').value) || 0;
            const a1c = parseFloat(document.getElementById('a1c').value) || 0;
            const ldl = parseInt(document.getElementById('ldl').value) || 0;
            const bmi = parseFloat(document.getElementById('bmi').value) || 0;
            const egfr = parseInt(document.getElementById('egfr').value) || 0;
            const phq9 = parseInt(document.getElementById('phq9').value) || 0;
            const gad7 = parseInt(document.getElementById('gad7').value) || 0;

            currentCodes = { cptii: [], gcode: [], mips: [], icd: [], suspect: [] };

            // BP-based codes
            if (sbp > 0 && dbp > 0) {
                if (sbp < 140 && dbp < 90) {
                    currentCodes.cptii.push({ code: '3074F', desc: 'BP < 140/90 mmHg' });
                    currentCodes.gcode.push({ code: 'G8752', desc: 'BP < 140/90 (HEDIS CBP)' });
                    currentCodes.mips.push({ code: 'G2215', desc: 'BP adequately controlled' });
                }
                if (sbp >= 140 || dbp >= 90) {
                    currentCodes.cptii.push({ code: '3077F', desc: 'BP >= 140/90 mmHg' });
                    currentCodes.gcode.push({ code: 'G8753', desc: 'BP >= 140/90 (not at goal)' });
                }
                currentCodes.icd.push({ code: 'I10', ...icdDatabase['I10'] });
            }

            // A1C-based codes
            if (a1c > 0) {
                if (a1c < 7) {
                    currentCodes.cptii.push({ code: '3044F', desc: 'A1C < 7.0%' });
                    currentCodes.gcode.push({ code: 'G9395', desc: 'HbA1c < 7% (HEDIS HBD)' });
                    currentCodes.mips.push({ code: 'G2089', desc: 'Diabetes: HbA1c < 7%' });
                } else if (a1c < 8) {
                    currentCodes.cptii.push({ code: '3045F', desc: 'A1C 7.0-7.9%' });
                    currentCodes.gcode.push({ code: 'G9396', desc: 'HbA1c 7-8% (HEDIS)' });
                } else if (a1c < 9) {
                    currentCodes.cptii.push({ code: '3046F', desc: 'A1C 8.0-8.9%' });
                    currentCodes.gcode.push({ code: 'G9397', desc: 'HbA1c 8-9% (HEDIS)' });
                } else {
                    currentCodes.cptii.push({ code: '3047F', desc: 'A1C >= 9.0% (poor control)' });
                    currentCodes.gcode.push({ code: 'G9398', desc: 'HbA1c >= 9% - poor control' });
                    currentCodes.mips.push({ code: 'G2091', desc: 'Diabetes: HbA1c poor control >9%' });
                }
                currentCodes.cptii.push({ code: '3048F', desc: 'A1C level documented' });
                currentCodes.icd.push({ code: 'E11.9', ...icdDatabase['E11.9'] });
                if (a1c >= 9) {
                    currentCodes.icd.push({ code: 'E11.65', ...icdDatabase['E11.65'] });
                }
            }

            // LDL-based codes - FIXED: Only add hyperlipidemia if on statin or manually selected
            if (ldl > 0) {
                currentCodes.cptii.push({ code: '3048F', desc: 'LDL documented' });
                if (ldl < 100) {
                    currentCodes.cptii.push({ code: '3049F', desc: 'LDL < 100 mg/dL' });
                    currentCodes.gcode.push({ code: 'G8786', desc: 'LDL < 100 (HEDIS SPC)' });
                } else {
                    currentCodes.cptii.push({ code: '3050F', desc: 'LDL >= 100 mg/dL' });
                }
                // Only add hyperlipidemia diagnosis if patient is on a statin or has it in selected diagnoses
                if (isOnStatin() || selectedDiagnoses.has('E78.5')) {
                    currentCodes.icd.push({ code: 'E78.5', ...icdDatabase['E78.5'] });
                }
            }

            // BMI-based codes
            if (bmi > 0) {
                currentCodes.cptii.push({ code: '3008F', desc: 'BMI documented' });
                if (bmi >= 25 && bmi < 30) {
                    currentCodes.icd.push({ code: 'E66.3', ...icdDatabase['E66.3'] });
                } else if (bmi >= 30 && bmi < 35) {
                    currentCodes.icd.push({ code: 'E66.811', ...icdDatabase['E66.811'] });
                } else if (bmi >= 35 && bmi < 40) {
                    currentCodes.icd.push({ code: 'E66.812', ...icdDatabase['E66.812'] });
                } else if (bmi >= 40) {
                    currentCodes.icd.push({ code: 'E66.01', ...icdDatabase['E66.01'] });
                }
            }

            // eGFR-based codes
            if (egfr > 0) {
                if (egfr >= 90) {
                    currentCodes.cptii.push({ code: '3060F', desc: 'eGFR >= 90 (Stage 1 or normal)' });
                } else if (egfr >= 60) {
                    currentCodes.cptii.push({ code: '3061F', desc: 'eGFR 60-89 (Stage 2)' });
                    currentCodes.icd.push({ code: 'N18.2', ...icdDatabase['N18.2'] });
                } else if (egfr >= 45) {
                    currentCodes.cptii.push({ code: '3062F', desc: 'eGFR 45-59 (Stage 3a)' });
                    currentCodes.icd.push({ code: 'N18.3', ...icdDatabase['N18.3'] });
                } else if (egfr >= 30) {
                    currentCodes.cptii.push({ code: '3063F', desc: 'eGFR 30-44 (Stage 3b)' });
                    currentCodes.icd.push({ code: 'N18.3', ...icdDatabase['N18.3'] });
                } else if (egfr >= 15) {
                    currentCodes.cptii.push({ code: '3064F', desc: 'eGFR 15-29 (Stage 4)' });
                    currentCodes.icd.push({ code: 'N18.4', ...icdDatabase['N18.4'] });
                } else {
                    currentCodes.cptii.push({ code: '3065F', desc: 'eGFR < 15 (Stage 5)' });
                    currentCodes.icd.push({ code: 'N18.5', ...icdDatabase['N18.5'] });
                }
            }

            // PHQ-9 based codes
            if (phq9 > 0) {
                currentCodes.cptii.push({ code: '3088F', desc: 'PHQ-9 documented' });
                currentCodes.gcode.push({ code: 'G8431', desc: 'Depression screening performed' });
                currentCodes.mips.push({ code: 'G9509', desc: 'Depression screening documented' });
                if (phq9 >= 10) {
                    currentCodes.icd.push({ code: 'F32.1', ...icdDatabase['F32.1'] });
                }
            }

            // GAD-7 based codes (NEW)
            if (gad7 > 0) {
                currentCodes.cptii.push({ code: '96127', desc: 'GAD-7 screening documented' });
                currentCodes.gcode.push({ code: 'G0444', desc: 'Anxiety screening performed' });
                if (gad7 >= 10) {
                    currentCodes.icd.push({ code: 'F41.1', ...icdDatabase['F41.1'] });
                }
            }

            // Add manually selected diagnoses to ICD codes if not already present
            selectedDiagnoses.forEach(code => {
                if (!currentCodes.icd.some(c => c.code === code) && icdDatabase[code]) {
                    currentCodes.icd.push({ code, ...icdDatabase[code] });
                }
            });

            renderQualityCodes();
            renderIcdCodes();
            updateSuspectCodes();
            updateCounters();
        }

        // ============ RENDER QUALITY CODES ============
        function renderQualityCodes() {
            renderCodeSection('cptii-section', 'CPT II Codes', 'quality', currentCodes.cptii, 'quality');
            renderCodeSection('gcode-section', 'Medicare G-Codes', 'quality', currentCodes.gcode, 'quality');
            renderCodeSection('mips-section', 'MIPS G-Codes', 'quality', currentCodes.mips, 'quality');
        }

        function renderCodeSection(containerId, title, badgeClass, codes, type) {
            const container = document.getElementById(containerId);
            if (codes.length === 0) {
                container.innerHTML = '';
                return;
            }

            const sectionKey = containerId.replace('-section', '');

            container.innerHTML = `
                <div class="section-controls">
                    <div class="section-info">
                        <span class="section-badge ${badgeClass}">${title}</span>
                        <span class="section-title">${codes.length} code(s)</span>
                    </div>
                    <div class="section-buttons">
                        <button class="section-btn accept-all" onclick="acceptAllSection('${sectionKey}', '${type}')">OK Accept All</button>
                        <button class="section-btn reject-all" onclick="rejectAllSection('${sectionKey}', '${type}')">X Reject All</button>
                    </div>
                </div>
                <div class="code-list">
                    ${codes.map((c, i) => renderCodeCard(c, `${sectionKey}-${i}`, type)).join('')}
                </div>
            `;
        }

        function renderCodeCard(code, id, type) {
            const acceptedSet = type === 'quality' ? acceptedQuality : (type === 'icd' ? acceptedIcd : acceptedSuspect);
            const isAccepted = acceptedSet.has(id);
            const isRejected = acceptedSet.has(id + '-rejected');
            const hasHcc = code.hcc_ma || code.hcc_comm;

            let hccBadges = '';
            if (code.hcc_ma) {
                hccBadges += `<span class="hcc-badge"><span class="payer-badge ma">MA</span> ${code.hcc_ma} <span class="raf">+${code.raf_ma.toFixed(3)}</span></span>`;
            }
            if (code.hcc_comm) {
                hccBadges += `<span class="hcc-badge"><span class="payer-badge comm">Comm</span> ${code.hcc_comm} <span class="raf">+${code.raf_comm.toFixed(3)}</span></span>`;
            }

            return `
                <div class="code-card ${hasHcc ? 'has-hcc' : ''} ${isAccepted ? 'accepted' : ''} ${isRejected ? 'rejected' : ''}" id="card-${id}">
                    <span class="code-value">${code.code}</span>
                    <div class="code-info">
                        <div class="code-desc">${code.desc}</div>
                        <div class="code-meta">${hccBadges}</div>
                    </div>
                    <div class="action-btns">
                        <button class="accept-btn ${isAccepted ? 'active' : ''}" onclick="acceptCode('${id}', '${type}')">OK Accept</button>
                        <button class="reject-btn ${isRejected ? 'active' : ''}" onclick="rejectCode('${id}', '${type}')">X Reject</button>
                    </div>
                </div>
            `;
        }

        // ============ RENDER ICD CODES ============
        function renderIcdCodes() {
            const container = document.getElementById('icd-section');
            if (currentCodes.icd.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">LIST</div><p>Enter clinical values to see ICD-10 recommendations</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="section-controls">
                    <div class="section-info">
                        <span class="section-badge icd">ICD-10 Diagnoses</span>
                        <span class="section-title">${currentCodes.icd.length} code(s)</span>
                    </div>
                    <div class="section-buttons">
                        <button class="section-btn accept-all" onclick="acceptAllSection('icd', 'icd')">OK Accept All</button>
                        <button class="section-btn reject-all" onclick="rejectAllSection('icd', 'icd')">X Reject All</button>
                    </div>
                </div>
                <div class="code-list">
                    ${currentCodes.icd.map((c, i) => renderCodeCard(c, `icd-${i}`, 'icd')).join('')}
                </div>
            `;
        }

        // ============ SUSPECT CODES ============
        function updateSuspectCodes() {
            const selectedMedData = getSelectedMedications();
            const suspectSet = new Set();
            selectedMedData.forEach(med => {
                med.suspects.forEach(code => suspectSet.add(code));
            });

            // Remove codes already in ICD list
            const icdCodes = currentCodes.icd.map(c => c.code);
            const suspectCodes = Array.from(suspectSet).filter(code => !icdCodes.includes(code));

            currentCodes.suspect = suspectCodes.map(code => ({
                code,
                ...icdDatabase[code]
            })).filter(c => c.desc);

            renderSuspectCodes();
            updateCounters();
        }

        function renderSuspectCodes() {
            const container = document.getElementById('suspect-section');
            if (currentCodes.suspect.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">PILL</div><p>Select medications to see suspect diagnoses</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="section-controls">
                    <div class="section-info">
                        <span class="section-badge suspect">Suspect Diagnoses</span>
                        <span class="section-title">${currentCodes.suspect.length} code(s)</span>
                    </div>
                    <div class="section-buttons">
                        <button class="section-btn accept-all" onclick="acceptAllSection('suspect', 'suspect')">OK Accept All</button>
                        <button class="section-btn reject-all" onclick="rejectAllSection('suspect', 'suspect')">X Reject All</button>
                    </div>
                </div>
                <div class="code-list">
                    ${currentCodes.suspect.map((c, i) => renderCodeCard(c, `suspect-${i}`, 'suspect')).join('')}
                </div>
            `;
        }

        // ============ ACCEPT/REJECT ACTIONS ============
        function acceptCode(id, type) {
            const set = type === 'quality' ? acceptedQuality : (type === 'icd' ? acceptedIcd : acceptedSuspect);
            set.delete(id + '-rejected');
            set.add(id);
            refreshSection(type);
            updateCounters();
            updateRAF();
            updateDocumentation();
        }

        function rejectCode(id, type) {
            const set = type === 'quality' ? acceptedQuality : (type === 'icd' ? acceptedIcd : acceptedSuspect);
            set.delete(id);
            set.add(id + '-rejected');
            refreshSection(type);
            updateCounters();
            updateRAF();
            updateDocumentation();
        }

        function acceptAllSection(sectionKey, type) {
            const set = type === 'quality' ? acceptedQuality : (type === 'icd' ? acceptedIcd : acceptedSuspect);
            let codes;
            if (sectionKey === 'cptii') codes = currentCodes.cptii;
            else if (sectionKey === 'gcode') codes = currentCodes.gcode;
            else if (sectionKey === 'mips') codes = currentCodes.mips;
            else if (sectionKey === 'icd') codes = currentCodes.icd;
            else if (sectionKey === 'suspect') codes = currentCodes.suspect;

            codes.forEach((_, i) => {
                const id = `${sectionKey}-${i}`;
                set.delete(id + '-rejected');
                set.add(id);
            });
            refreshSection(type);
            updateCounters();
            updateRAF();
            updateDocumentation();
        }

        function rejectAllSection(sectionKey, type) {
            const set = type === 'quality' ? acceptedQuality : (type === 'icd' ? acceptedIcd : acceptedSuspect);
            let codes;
            if (sectionKey === 'cptii') codes = currentCodes.cptii;
            else if (sectionKey === 'gcode') codes = currentCodes.gcode;
            else if (sectionKey === 'mips') codes = currentCodes.mips;
            else if (sectionKey === 'icd') codes = currentCodes.icd;
            else if (sectionKey === 'suspect') codes = currentCodes.suspect;

            codes.forEach((_, i) => {
                const id = `${sectionKey}-${i}`;
                set.delete(id);
                set.add(id + '-rejected');
            });
            refreshSection(type);
            updateCounters();
            updateRAF();
            updateDocumentation();
        }

        function refreshSection(type) {
            if (type === 'quality') renderQualityCodes();
            else if (type === 'icd') renderIcdCodes();
            else if (type === 'suspect') renderSuspectCodes();
        }

        // ============ RAF CALCULATION ============
        function updateRAF() {
            let rafMa = 0, rafComm = 0;

            // ICD codes
            currentCodes.icd.forEach((code, i) => {
                if (acceptedIcd.has(`icd-${i}`)) {
                    rafMa += code.raf_ma || 0;
                    rafComm += code.raf_comm || 0;
                }
            });

            // Suspect codes
            currentCodes.suspect.forEach((code, i) => {
                if (acceptedSuspect.has(`suspect-${i}`)) {
                    rafMa += code.raf_ma || 0;
                    rafComm += code.raf_comm || 0;
                }
            });

            document.getElementById('rafMa').textContent = rafMa.toFixed(3);
            document.getElementById('rafComm').textContent = rafComm.toFixed(3);
        }

        // ============ DOCUMENTATION ============
        function updateDocumentation() {
            const docContainer = document.getElementById('doc-section');
            const acceptedDiagnoses = [];

            // Get accepted ICD codes
            currentCodes.icd.forEach((code, i) => {
                if (acceptedIcd.has(`icd-${i}`)) {
                    acceptedDiagnoses.push(code);
                }
            });

            // Get accepted suspect codes
            currentCodes.suspect.forEach((code, i) => {
                if (acceptedSuspect.has(`suspect-${i}`)) {
                    acceptedDiagnoses.push(code);
                }
            });

            // Add screening documentation
            const screeningDocs = [];
            selectedScreenings.forEach(id => {
                const screen = screeningMeasures.find(s => s.id === id);
                if (screen) {
                    screeningDocs.push({
                        code: screen.code,
                        desc: screen.name,
                        docText: screen.docText
                    });
                }
            });

            if (acceptedDiagnoses.length === 0 && screeningDocs.length === 0) {
                docContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">DOC</div><p>Accept diagnoses or select screenings to see documentation snippets</p></div>';
                return;
            }

            const docSnippets = {
                'I10': 'Essential hypertension. BP monitored today. Continue current antihypertensive regimen.',
                'I11.0': 'Hypertensive heart disease with heart failure. LVEF documented. On guideline-directed medical therapy.',
                'I50.9': 'Heart failure. Patient on optimal medical management including ACE/ARB, beta-blocker, and diuretic as tolerated.',
                'I25.10': 'Coronary artery disease without angina. On statin, aspirin, and beta-blocker. No chest pain.',
                'I48.91': 'Atrial fibrillation. Rate/rhythm control addressed. Anticoagulation therapy discussed.',
                'I73.9': 'Peripheral vascular disease. Claudication symptoms assessed. On antiplatelet therapy.',
                'E11.9': 'Type 2 diabetes mellitus. A1C reviewed today. Continue current diabetes management plan.',
                'E11.65': 'Type 2 diabetes with hyperglycemia. A1C above goal. Discussed treatment intensification.',
                'E11.22': 'Type 2 diabetes with diabetic chronic kidney disease. Monitoring renal function closely.',
                'E66.01': 'Morbid obesity, BMI 40 or higher. Discussed lifestyle modifications and treatment options.',
                'E66.811': 'Obesity class 1, BMI 30-34.9. Counseled on diet and exercise.',
                'E66.812': 'Obesity class 2, BMI 35-39.9. Discussed weight management strategies.',
                'E66.3': 'Overweight, BMI 25-29.9. Encouraged healthy lifestyle habits.',
                'E66.9': 'Obesity documented. Discussed lifestyle modifications and weight management.',
                'E78.5': 'Hyperlipidemia. On statin therapy. LDL level reviewed.',
                'E03.9': 'Hypothyroidism. TSH levels monitored. Continue current thyroid replacement therapy.',
                'N18.2': 'CKD Stage 2. eGFR 60-89. Monitoring renal function.',
                'N18.3': 'CKD Stage 3. eGFR 30-59. Avoiding nephrotoxic agents. On ACE/ARB for renal protection.',
                'N18.4': 'CKD Stage 4. eGFR 15-29. Nephrology co-management. Discussed prognosis.',
                'N18.5': 'CKD Stage 5. eGFR less than 15. Dialysis planning discussions initiated.',
                'F32.1': 'Major depressive disorder, moderate. PHQ-9 score documented. On antidepressant therapy.',
                'F41.1': 'Generalized anxiety disorder. GAD-7 score documented. Treatment options discussed.',
                'F17.210': 'Tobacco use disorder, cigarettes. Counseled on cessation. Offered pharmacotherapy.',
            };

            let html = '';

            // Screening documentation cards
            if (screeningDocs.length > 0) {
                html += '<h4 style="font-size: 12px; color: var(--purple); margin-bottom: 10px;">Screening Orders</h4>';
                screeningDocs.forEach(screen => {
                    const docId = `doc-screen-${screen.code}`;
                    const savedText = docTexts[docId] || screen.docText;
                    const isSelected = selectedDocs.has(docId);

                    html += `
                        <div class="doc-card ${isSelected ? 'selected' : ''}">
                            <div class="doc-card-header">
                                <input type="checkbox" class="doc-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleDoc('${docId}')">
                                <span class="doc-card-title">${screen.code} - ${screen.desc}</span>
                            </div>
                            <textarea class="doc-text" id="${docId}" onfocus="autoSelectDoc('${docId}')" oninput="saveDocText('${docId}')">${savedText}</textarea>
                        </div>
                    `;
                });
            }

            // Diagnosis documentation cards
            if (acceptedDiagnoses.length > 0) {
                html += '<h4 style="font-size: 12px; color: var(--olive); margin: 16px 0 10px;">Diagnosis Documentation</h4>';
                acceptedDiagnoses.forEach(code => {
                    const docId = `doc-${code.code}`;
                    const defaultText = docSnippets[code.code] || `${code.desc}. Addressed today. Plan documented.`;
                    const savedText = docTexts[docId] || defaultText;
                    const isSelected = selectedDocs.has(docId);

                    html += `
                        <div class="doc-card ${isSelected ? 'selected' : ''}">
                            <div class="doc-card-header">
                                <input type="checkbox" class="doc-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleDoc('${docId}')">
                                <span class="doc-card-title">${code.code} - ${code.desc}</span>
                            </div>
                            <textarea class="doc-text" id="${docId}" onfocus="autoSelectDoc('${docId}')" oninput="saveDocText('${docId}')">${savedText}</textarea>
                        </div>
                    `;
                });
            }

            docContainer.innerHTML = html;
        }

        function toggleDoc(id) {
            if (selectedDocs.has(id)) {
                selectedDocs.delete(id);
            } else {
                selectedDocs.add(id);
            }
            updateDocumentation();
            updateCounters();
        }

        function autoSelectDoc(id) {
            if (!selectedDocs.has(id)) {
                selectedDocs.add(id);
                updateDocumentation();
                updateCounters();
                // Re-focus the textarea
                setTimeout(() => document.getElementById(id)?.focus(), 0);
            }
        }

        function saveDocText(id) {
            const textarea = document.getElementById(id);
            if (textarea) {
                docTexts[id] = textarea.value;
            }
        }

        // ============ COUNTERS ============
        function updateCounters() {
            const qualityCount = Array.from(acceptedQuality).filter(id => !id.endsWith('-rejected')).length;
            const icdCount = Array.from(acceptedIcd).filter(id => !id.endsWith('-rejected')).length;
            const suspectCount = Array.from(acceptedSuspect).filter(id => !id.endsWith('-rejected')).length;
            const docCount = selectedDocs.size;

            document.getElementById('qualityCount').textContent = qualityCount;
            document.getElementById('icdCount').textContent = icdCount;
            document.getElementById('suspectCount').textContent = suspectCount;
            document.getElementById('docCount').textContent = docCount;
        }

        // ============ SUMMARY GENERATION ============
        function generateSummary() {
            showTab('summary');

            const age = document.getElementById('patientAge').value;
            const sex = document.getElementById('patientSex').value;
            const sbp = document.getElementById('sbp').value;
            const dbp = document.getElementById('dbp').value;
            const a1c = document.getElementById('a1c').value;
            const ldl = document.getElementById('ldl').value;
            const bmi = document.getElementById('bmi').value;
            const egfr = document.getElementById('egfr').value;
            const phq9 = document.getElementById('phq9').value;
            const gad7 = document.getElementById('gad7').value;

            let summary = '=== CLINICAL ENCOUNTER SUMMARY ===\n\n';

            // Demographics
            if (age || sex) {
                summary += '--- DEMOGRAPHICS ---\n';
                if (age) summary += `Age: ${age} years\n`;
                if (sex) summary += `Sex: ${sex.charAt(0).toUpperCase() + sex.slice(1)}\n`;
                summary += '\n';
            }

            // Vitals/Labs
            summary += '--- VITALS & LABS ---\n';
            if (sbp && dbp) summary += `BP: ${sbp}/${dbp} mmHg\n`;
            if (a1c) summary += `A1C: ${a1c}%\n`;
            if (ldl) summary += `LDL: ${ldl} mg/dL\n`;
            if (bmi) summary += `BMI: ${bmi} kg/m2\n`;
            if (egfr) summary += `eGFR: ${egfr} mL/min/1.73m2\n`;
            if (phq9) summary += `PHQ-9: ${phq9}\n`;
            if (gad7) summary += `GAD-7: ${gad7}\n`;
            summary += '\n';

            // Accepted Quality Codes
            const acceptedQualityCodes = [];
            currentCodes.cptii.forEach((c, i) => { if (acceptedQuality.has(`cptii-${i}`)) acceptedQualityCodes.push(c); });
            currentCodes.gcode.forEach((c, i) => { if (acceptedQuality.has(`gcode-${i}`)) acceptedQualityCodes.push(c); });
            currentCodes.mips.forEach((c, i) => { if (acceptedQuality.has(`mips-${i}`)) acceptedQualityCodes.push(c); });

            if (acceptedQualityCodes.length > 0) {
                summary += '--- QUALITY CODES ---\n';
                acceptedQualityCodes.forEach(c => {
                    summary += `${c.code}: ${c.desc}\n`;
                });
                summary += '\n';
            }

            // Screening Orders
            if (selectedScreenings.size > 0) {
                summary += '--- SCREENING ORDERS ---\n';
                selectedScreenings.forEach(id => {
                    const screen = screeningMeasures.find(s => s.id === id);
                    if (screen) {
                        summary += `${screen.code}: ${screen.name}\n`;
                    }
                });
                summary += '\n';
            }

            // Accepted ICD-10 Codes
            const acceptedIcdCodes = [];
            currentCodes.icd.forEach((c, i) => { if (acceptedIcd.has(`icd-${i}`)) acceptedIcdCodes.push(c); });
            currentCodes.suspect.forEach((c, i) => { if (acceptedSuspect.has(`suspect-${i}`)) acceptedIcdCodes.push(c); });

            if (acceptedIcdCodes.length > 0) {
                summary += '--- DIAGNOSES (ICD-10) ---\n';
                acceptedIcdCodes.forEach(c => {
                    let line = `${c.code}: ${c.desc}`;
                    if (c.hcc_ma) line += ` [MA: ${c.hcc_ma}, RAF +${c.raf_ma}]`;
                    if (c.hcc_comm) line += ` [Comm: ${c.hcc_comm}, RAF +${c.raf_comm}]`;
                    summary += line + '\n';
                });
                summary += '\n';
            }

            // Selected Documentation
            if (selectedDocs.size > 0) {
                summary += '--- ASSESSMENT & PLAN ---\n';
                selectedDocs.forEach(id => {
                    const textarea = document.getElementById(id);
                    const text = textarea ? textarea.value : docTexts[id];
                    if (text) {
                        summary += text + '\n\n';
                    }
                });
            }

            // Selected Medications
            const selectedMedData = getSelectedMedications();
            if (selectedMedData.length > 0) {
                summary += '--- CURRENT MEDICATIONS ---\n';
                selectedMedData.forEach(med => {
                    summary += `- ${med.name} (${med.class})\n`;
                });
            }

            document.getElementById('summaryNote').textContent = summary;
        }

        function copySummary() {
            const summary = document.getElementById('summaryNote').textContent;
            navigator.clipboard.writeText(summary).then(() => {
                alert('Summary copied to clipboard!');
            });
        }

        function copyToAthena() {
            generateSummary();
            copySummary();
            alert('Summary copied! Paste into Athena EHR.');
        }

        // ============ TABS ============
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active', 'suspect'));

            document.getElementById(`${tabName}-tab`).classList.add('active');
            const tabBtn = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
                if (tabName === 'suspect') tabBtn.classList.add('suspect');
            }
        }

        // ============ CLEAR ALL ============
        function clearAll() {
            document.getElementById('patientAge').value = '';
            document.getElementById('patientSex').value = '';
            document.getElementById('sbp').value = '';
            document.getElementById('dbp').value = '';
            document.getElementById('a1c').value = '';
            document.getElementById('ldl').value = '';
            document.getElementById('bmi').value = '';
            document.getElementById('egfr').value = '';
            document.getElementById('phq9').value = '';
            document.getElementById('gad7').value = '';

            selectedMeds.clear();
            selectedDiagnoses.clear();
            selectedScreenings.clear();
            acceptedQuality.clear();
            acceptedIcd.clear();
            acceptedSuspect.clear();
            selectedDocs.clear();
            docTexts = {};
            currentCodes = { cptii: [], gcode: [], mips: [], icd: [], suspect: [] };

            renderMedications();
            renderScreenings();
            renderSelectedDiagnoses();
            renderQualityCodes();
            renderIcdCodes();
            renderSuspectCodes();
            updateDocumentation();
            updateCounters();
            updateRAF();
            document.getElementById('summaryNote').textContent = 'Enter clinical values and accept codes to generate summary...';
        }

        // Initialize
        init();
    </script>
</body>
</html>
